# Проектная работа "Веб-ларек"

Стек: HTML, SCSS, TS, Webpack

Структура проекта:
- src/ — исходные файлы проекта
- src/components/ — папка с JS компонентами
- src/components/base/ — папка с базовым кодом

Важные файлы:
- src/pages/index.html — HTML-файл главной страницы
- src/types/index.ts — файл с типами
- src/index.ts — точка входа приложения
- src/scss/styles.scss — корневой файл стилей
- src/utils/constants.ts — файл с константами
- src/utils/utils.ts — файл с утилитами

## Установка и запуск
Для установки и запуска проекта необходимо выполнить команды

```
npm install
npm run start
```

или

```
yarn
yarn start
```
## Сборка

```
npm run build
```

или

```
yarn build
```

## Данные и типы данных, используемые в приложении

Карточка

```
export interface IItem { 
	id: string;
	title: string;
	image: string;
	category: string;
	description: string;
	price: number | null;
}

```

Массив карточек для вывода на страницу

```
export interface IItemList { 
	items: IItem[];
	total: number;
}
```

Данные карточки, используемые для открытия и дальнейшей работы с карточкой

```
export type IItemCard = IItem; 
```

Данные id, используемые для работы с данными

```
export type ItemId = IItem['id']; 
```

#### Данные используемые для оформления заказа

Данные для выбора типа оплаты

```
export type PaymentType = "online" | "offline"; 
```

Обработка оформления заказа

```
export interface IOrder { 
payment: PaymentType;
email: string;
phone: string;
address: string;
total: number;
items: string[];
}

```

Ответ сервера

```
export interface IOrderResponse { 
id: string;
total: number;
}

```

## Архитектура приложения

Код приложения разделен на слои согласно парадигме MVP:
- слой представления, отвечает за отображение данных на странице,
- слой данных, отвечает за хранение и изменение данных
- презентер, отвечает за связь представления и данных.

### Базовый код

#### Класс Api

Содержит в себе базовую логику отправки запросов. В конструктор передается базовый адрес сервера и опциональный объект с заголовками запросов.
Методы:
- `get` - выполняет GET запрос на переданный в параметрах ендпоинт и возвращает промис с объектом, которым ответил сервер
- `post` - принимает объект с данными, которые будут переданы в JSON в теле запроса, и отправляет эти данные на ендпоинт переданный как параметр при вызове метода. По умолчанию выполняется `POST` запрос, но метод запроса может быть переопределен заданием третьего параметра при вызове.

#### Класс EventEmitter

Брокер событий позволяет отправлять события и подписываться на события, происходящие в системе. Класс используется в презентере для обработки событий и в слоях приложения для генерации событий.  
Основные методы, реализуемые классом описаны интерфейсом `IEvents`:
- `on` - подписка на событие
- `emit` - инициализация события
- `trigger` - возвращает функцию, при вызове которой инициализируется требуемое в параметрах событие   

### Слой данных

#### Класс ItemModel

Класс отвечает за хранение всех карточек и выбранный товар.\
Конструктор класса принимает инстант брокера событий\
В полях класса хранятся следующие данные:

- `_items: IItemList` - список всех карточек
- `_preview: ItemId | null` - id карточки, которая выбрана для просмтора
- `events: IEvents` - экземпляр класса `EventEmitter` для инициации событий при изменении данных.

Так же класс предоставляет набор методов для взаимодействия с этими данными.

- `setItems(items: IItem[]): void` — сохраняет список карточек
- `getAllItems (): IItem[]` - возвращает список всех карточек
- `getItem (id: ItemId): IItemCard | null` - находит карточку по id
- `setPreview(id: ItemId): void` — находит карточку по id и генерирует событие
- `getPreview(): IItemCard | null` — возвращает выбранную карточку

### Класс CartModel 

Класс отвечает за хранение выбранных товаров, а также выполняет основную логику работы с данными корзины.\
Конструктор класса принимает инстант брокера событий\
В полях класса хранятся следующие данные:

- `_items: ItemId[]` - список id товаров в корзине
- `events: IEvents` - экземпляр класса `EventEmitter` для инициации событий при изменении данных.

Так же класс предоставляет набор методов для взаимодействия с этими данными.

- `addItem(id: ItemId): void` - добавляет товар в корзину и сохраняет состояние
- `deleteItem(id: ItemId): void` - удаляет товар из корзины, сохраняет состояние
- `clearCart(): void` - очищает корзину
- `get items():ItemId[]` - геттер, возвращает текущие id товаров
- `get count():number`- геттер, возвращает кол-во товаров в корзине
- `save:void` - сохраняет состояние корзины в localStorage
- `load:void` - загружает состояние корзины из localStorage

### Класс OrderModal

Класс отвечает за хранение данных текущего заказ и подготовку для отправки данных на сервер\
Конструктор класса принимает инстант брокера событий\
В полях класса хранятся следующие данные:

- `_order: IOrder` - данные покупателя
- `events: IEvents` - экземпляр класса `EventEmitter` для инициации событий при изменении данных.

Так же класс предоставляет набор методов для взаимодействия с этими данными.

- `setItems(id: ItemId[]): void` - список id товаров
- `get items(): string[]` - геттер, получить список товаров
- `setTotal(total: number): void` - получение итоговой суммы(считает презентер)
- `setPayment(payment: PaymentType): void` - установка способа оплаты
- `get payment(): PaymentType | null` - получение способа оплаты
- `setAddress(adress: string): void` - установка адреса покупателя
- `get address(): string` - получение адреса покупателя
- `setEmail(email: string): void` - установка email покупателя
- `get email(): string` - получение email покупателя
- `setPhone(phone: string): void` - установка номера телефона покупателя
- `get phone():string` - получение номера телефона покупателя
- `validationAddress(): boolean` - валидация модального окна с формой оплаты и адреса
- `validationContacts(): boolean` - валидация модального окна с формой номера и почты
- `validationGeneral(): boolean` - финальная, общая валидация для двух модальных окон
- `submit(api: ApiService): Promise<IOrderResponse>` - формирует тело запроса и отправляет на сервер
- `clear(): void` - сбрасывает все данные

### Классы представления

Все классы представления отвечают за отображение внутри контейнера (DOM-элемент) передаваемых в них данных.

#### Класс ModalView
Базовый класс, который отвечает за open/close и за поля повторяющиеся

- `constructor(container: HTMLElement, events: IEvents)` Конструктор принимает селектор, по которому будет идентифицированы разметка модального окна и также экземпляр класса `EventEmitter` для возможности инициации событий.

Поля класса:

- `_container: HTMLElement` - элемент контейнера модального окна 
- `events: IEvents` - брокер событий

Так же класс предоставляет набор методов:

- `open(): void` - открывает модальное окно
- `close(): void` - закрывает модальное окно


#### Класс CardView
Наследует класс ModalView.\
Класс отвечает за отображение карточек товара на главном экране и внутри модального окна.
- `constructor(container: HTMLElement, modalContainer: HTMLElement, events: IEvents)` Конструктор принимает селектор, по которому будет идентифицированы разметка и модальное окно, а также экземпляр класса `EventEmitter` для возможности инициации событий.

Поля класса:

- Наследует класс ModalView.
- `_modal: HTMLElement` - элемент модального окна

Так же класс предоставляет набор методов:

- `render(item: IItemCard[]): void` - отрисовывает карточки на главном экране
- `toggleButton(inCart: boolean): void` - меняет состояние кнопки в корзине

#### Класс CartView
Наследует класс ModalView.\
Класс отвечает за отображение корзины и управление ее содержимым
- `constructor(container: HTMLElement, counter: HTMLElement, events: IEvents)` Конструктор принимает селектор, по которому будет идентифицированы разметка корзины и также экземпляр класса `EventEmitter` для возможности инициации событий.

Поля класса:

- Наследует класс ModalView.
- `_counter: HTMLElement` - счетчик товаров

Так же класс предоставляет набор методов:

- `render(items: IItemCard[], total: number): void` - отрисовывает корзину
- `toggleButton(isEmpty: boolean): void` - отображает надпись если корзина пустая и блокирует кнопку
- `deleteItem(id: ItemId): void` - удаляет товар из DOM
- `updateCount(count: number): void` - обновляет кол-во товаров в корзине на главном экране

#### Класс OrderAddressView
Наследует класс ModalView.\
Класс отвечает за отображение модального окна формы с адресом и выбором оплаты
- `constructor(container: HTMLElement, events: IEvents)` Конструктор принимает селектор, по которому будет идентифицированы разметка модального окна и также экземпляр класса `EventEmitter` для возможности инициации событий.

Поля класса:

- Наследует класс ModalView.

Так же класс предоставляет набор методов:

- `render(address: string, payment: PaymentType): void` - отрисовывает форму
- `setAddress(address: string): void` - устанавливает значение поля адреса
- `setPayment(payment: PaymentType): void` - устанавливает способ оплаты
- `toggleButton(isEmpty: boolean): void` - блокирует кнопку

#### Класс OrderContactsView
Наследует класс ModalView.\
Класс отвечает за отображение модального окна формы с контактами
- `constructor(container: HTMLElement, events: IEvents)` Конструктор принимает селектор, по которому будет идентифицированы разметка модального окна и также экземпляр класса `EventEmitter` для возможности инициации событий.

Поля класса:

- Наследует класс ModalView.

Так же класс предоставляет набор методов:

- `render(email: string, phone: string): void` - отрисовывает форму
- `setEmail(email: string): void` - устанавливает значение поля email
- `setPhone(phone: string): void` - устанавливает значение поля phone
- `toggleButton(isEmpty: boolean): void` - блокирует кнопку

#### Класс OrderSuccessView
Наследует класс ModalView.\
Класс отвечает за отображение финального модального окна заказа
- `constructor(container: HTMLElement, events: IEvents)` Конструктор принимает селектор, по которому будет идентифицированы разметка модального окна и также экземпляр класса `EventEmitter` для возможности инициации событий.

Поля класса:

- Наследует класс ModalView.

Так же класс предоставляет набор методов:

- `render(total: number): void` - отображает финальное окно

### Слой коммуникации

#### Класс ShopApi

Принимает в конструктор экземпляр класса Api и предоставляет методы реализующие взаимодействие с бэкендом сервиса.

## Взаимодействие компонентов

Презентер отвечает за координацию работы между моделями ItemModel, CartModal и OrderModal, представлениями ModalView, CardView, CartView, OrderAddressView, OrderContactsView и OrderSuccessView, а также внешним слоем ModalApi 
Он подписывается на события от представления, обрабатывает бизнес-логику и вызывает соответствующие методы модели и обновления UI.\

#### класс Presenter

Класс отвечает за организацию бизнес-логики приложения и координацию работы между слоями.
- `constructor(items: ItemModel, cart: CartModel, order: OrderModel, cardView: CardView, cartView: CartView, orderAddressView: OrderAddressView, orderContactsView: OrderContactsView, orderSuccessView: OrderSuccessView, api: ShopApi, events: IEvents)` Конструктор принимает классы модели данных, классы представления, api и также экземпляр класса `EventEmitter` для возможности инициации событий. 

Поля класса:

- `_items: ItemModel` - класс отвечающий за хранение карточек
- `_cart: CartModel` - класс отвечающий за работу с корзиной
- `_order: OrderModal` - класс отвечающий за обработку заказа
- `_cardView: CardView` - класс отвечает за отображение карточек и модального окна товара
- `_cartView: CartView` - класс отвечает за отображение корзины и управление ее содержимым
- `_orderAddressView: OrderAddressView` - класс отвечает за отображение модального окна заказа
- `_orderContactsView: OrderContactsView` - класс отвечает за отображение модального окна заказа
- `_orderSuccessView: OrderSuccessView` - класс отвечает за отображение модального окна успешного заказа
- `_api: ShopApi` - класс отвечает за запросы к серверу
- `events: IEvents` - брокер событий
 
Методы класса: 

- `init(): void` - инициализация приложения, загрузка товаров из api, отображение списка
- `calculateTotal(): number` - считает общую сумму корзины
- `clickItem(id: ItemId): void` - открывает модальное окно с данными товара и вызывает событие для отображения нужного товара
- `clickAddToCart(id: ItemId): void` - добавляет товар в корзину
- `clickRemoveFromCart(id: ItemId): void` - удаляет товар из корзины
- `openCart(): void` - открывает корзину
- `openOrderAddress(): void` - открывает модальное окно с вводом адреса
- `submitAddress(address: string, payment: PaymentType): void` - сохраняет данные 
- `openOrderContacts(): void` - открывает модальное окно с вводом контактов
- `submitContacts(email: string, phone: string): void` - сохраняет данные
- `submitOrder(): Promise<void>` - отправляет данные, открывает окно с выполненным заказом
- `closeModal():void` - закрывает модальное окно

Код, описывающий взаимодействие представления и данных между собой находится в файле `presenter.ts`\
Взаимодействие осуществляется за счет событий генерируемых с помощью брокера событий и обработчиков этих событий, описанных в `index.ts`\
В `presenter.ts` сначала создаются экземпляры всех необходимых классов, а затем настраивается обработка событий.

*Список всех событий, которые могут генерироваться в системе:*\
*События изменения данных (генерируются классами моделями данных)*
- `items:changed` - изменение массива карточек товаров
- `item:preview` - выбор карточки для открытия в модальном окне
- `item:previewClear` - очистка данных выбранной для показа карточки 
- `cart:changed` - изменения содержимого корзины
- `order:created` - успешное создание заказа

*События, возникающие при взаимодействии пользователя с интерфейсом (генерируются классами, отвечающими за представление)*
- `item:click` - открытие модального окна с товаром
- `item:add` - добавление товара в корзину
- `item:delete` - удаление товара из корзины(в самой корзине и в модальном окне)
- `cart:open` - открытие модального окна корзины
- `cart:close` - закрытие модального окна корзины
- `cart:checkout` - нажатие кнопки оформить заказ
- `order:address:submit` - подтверждение формы с адресом и типом оплаты
- `order:contacts:submit` - подтверждение формы с контактами
- `order:success:close` - кнопка в финальном окне
- `modal:close` - закрытие любого модального окна




