# Проектная работа "Веб-ларек"

Стек: HTML, SCSS, TS, Webpack

Структура проекта:
- src/ — исходные файлы проекта
- src/components/ — папка с JS компонентами
- src/components/base/ — папка с базовым кодом

Важные файлы:
- src/pages/index.html — HTML-файл главной страницы
- src/types/index.ts — файл с типами
- src/index.ts — точка входа приложения
- src/scss/styles.scss — корневой файл стилей
- src/utils/constants.ts — файл с константами
- src/utils/utils.ts — файл с утилитами

## Установка и запуск
Для установки и запуска проекта необходимо выполнить команды

```
npm install
npm run start
```

или

```
yarn
yarn start
```
## Сборка

```
npm run build
```

или

```
yarn build
```

## Данные и типы данных, используемые в приложении

Карточка

```
export interface IItem { 
	id: string;
	title: string;
	image: string;
	category: string;
	description: string;
	price: number | null;
}

```

Массив карточек для вывода на страницу

```
export interface IItemList { 
	items: IItem[];
	total: number;
}
```

Данные карточки, используемые для открытия и дальнейшей работы с карточкой

```
export type IItemCard = IItem; 
```

Данные id, используемые для работы с данными

```
export type ItemId = IItem['id']; 
```

#### Данные используемые для оформления заказа

Данные для выбора типа оплаты

```
export type PaymentType = "online" | "offline"; 
```

Обработка оформления заказа

```
export interface IOrder { 
payment: PaymentType;
email: string;
phone: string;
address: string;
total: number;
items: string[];
}

```

Ответ сервера

```
export interface IOrderResponse { 
id: string;
total: number;
}

```

## Архитектура приложения

Код приложения разделен на слои согласно парадигме MVP:
- слой представления, отвечает за отображение данных на странице,
- слой данных, отвечает за хранение и изменение данных
- презентер, отвечает за связь представления и данных.

### Базовый код

#### Класс Api

Содержит в себе базовую логику отправки запросов. В конструктор передается базовый адрес сервера и опциональный объект с заголовками запросов.
Методы:
- `get` - выполняет GET запрос на переданный в параметрах ендпоинт и возвращает промис с объектом, которым ответил сервер
- `post` - принимает объект с данными, которые будут переданы в JSON в теле запроса, и отправляет эти данные на ендпоинт переданный как параметр при вызове метода. По умолчанию выполняется `POST` запрос, но метод запроса может быть переопределен заданием третьего параметра при вызове.

#### Класс EventEmitter

Брокер событий позволяет отправлять события и подписываться на события, происходящие в системе. Класс используется в презентере для обработки событий и в слоях приложения для генерации событий.  
Основные методы, реализуемые классом описаны интерфейсом `IEvents`:
- `on` - подписка на событие
- `emit` - инициализация события
- `trigger` - возвращает функцию, при вызове которой инициализируется требуемое в параметрах событие   

### Слой данных

#### Класс ItemModel

Класс отвечает за хранение всех карточек и выбранный товар.\
Конструктор класса принимает инстант брокера событий\
В полях класса хранятся следующие данные:

- `_items: IItemList` - список всех карточек
- `_preview: ItemId | null` - id карточки, которая выбрана для просмтора
- `events: IEvents` - экземпляр класса `EventEmitter` для инициации событий при изменении данных.

Так же класс предоставляет набор методов для взаимодействия с этими данными.

- `setItems(items: IItem[]): void` — сохраняет список карточек
- `getAllItems (): IItem[]` - возвращает список всех карточек
- `getItem (id: ItemId): IItemCard | null` - находит карточку по id
- `setPreview(id: ItemId): void` — находит карточку по id и генерирует событие
- `getPreview(): IItemCard | null` — возвращает выбранную карточку

### Класс CartModel 

Класс отвечает за хранение выбранных товаров, а также выполняет основную логику работы с данными корзины.\
Конструктор класса принимает инстант брокера событий\
В полях класса хранятся следующие данные:

- `_items: ItemId[]` - список id товаров в корзине
- `events: IEvents` - экземпляр класса `EventEmitter` для инициации событий при изменении данных.

Так же класс предоставляет набор методов для взаимодействия с этими данными.

- `addItem(id: ItemId): void` - добавляет товар в корзину и сохраняет состояние
- `deleteItem(id: ItemId): void` - удаляет товар из корзины, сохраняет состояние
- `clearCart(): void` - очищает корзину
- `get items():ItemId[]` - геттер, возвращает текущие id товаров
- `get count():number`- геттер, возвращает кол-во товаров в корзине
- `save:void` - сохраняет состояние корзины в localStorage
- `load:void` - загружает состояние корзины из localStorage

### Класс OrderModel

Класс отвечает за хранение данных текущего заказ и подготовку для отправки данных на сервер\
Конструктор класса принимает инстант брокера событий\
В полях класса хранятся следующие данные:

- `_data: IOrderForm` - объект с полями формы заказа
- `payment: PaymentType | null` - способ оплаты
- `address: string` - адрес покупателя
- `email: string` - email покупателя
- `phone: string` - телефон покупателя
- `events: IEvents` - экземпляр класса `EventEmitter` для инициации событий при изменении данных.

Так же класс предоставляет набор методов для взаимодействия с этими данными.

- `updateInput(key: IOrderFormInput, value: string | PaymentType): void` - обновляет одно поле формы
- `validateInput(input: IOrderFormInput): boolean` - проверяет корректность отдельного поля
- `validateForm(): boolean` - проверяет корректность всей формы
- `clear(): void` - сбрасывает все данные

### Классы представления

Все классы представления отвечают за отображение внутри контейнера (DOM-элемент) передаваемых в них данных.

#### Класс ModalView

Управляет отображением модального окна: закрытие, открытие, вставка контента, работа с оверлеем)

- `constructor(container: HTMLElement, events: IEvents)` Конструктор принимает селектор, по которому будет идентифицированы разметка модального окна и также экземпляр класса `EventEmitter` для возможности инициации событий.

Поля класса:

- `_container: HTMLElement` - элемент контейнера модального окна 
- `_overlay: HTMLElement` - оверлей
- `_content: HTMLElement` - контейнер для вставки содержимого
- `events: IEvents` - брокер событий

Так же класс предоставляет набор методов:

- `open(content: HTMLElement): void` - вставляет контент и открывает модальное окно
- `close(): void` - закрывает модальное окно и очищает контент
- `setContent(content: HTMLElement): void` - заменяет содержимое без закрытия модалки


#### Класс CardView

Класс отвечает за просмотр карточек товара 

- `constructor(container: HTMLElement, events: IEvents)` Конструктор принимает селектор, по которому будет идентифицированы разметка, а также экземпляр класса `EventEmitter` для возможности инициации событий.

Поля класса:

- `_container: HTMLElement` - элемент контейнера модального окна
- `events: IEvents` - брокер событий

Так же класс предоставляет набор методов:

- `render(card: IItemCard, inCart: boolean): HTMLElement` - рендорит карточку

#### Класс CartView

Класс отвечает за отображение корзины в модальном окне

- `constructor(container: HTMLElement, events: IEvents)` Конструктор принимает селектор, по которому будет идентифицированы разметка корзины и также экземпляр класса `EventEmitter` для возможности инициации событий.

Поля класса:

- `_container: HTMLElement` - элемент контейнера модального окна
- `events: IEvents` - брокер событий

Так же класс предоставляет набор методов:

- `render(items: IItemCard[], total: number): HTMLElement` - рендорит корзину

#### Класс OrderAddressView

Класс отвечает за отображение модального окна формы с адресом и выбором оплаты
- `constructor(container: HTMLElement, events: IEvents)` Конструктор принимает селектор, по которому будет идентифицированы разметка модального окна и также экземпляр класса `EventEmitter` для возможности инициации событий.

Поля класса:

- `_container: HTMLElement` - элемент контейнера модального окна
- `events: IEvents` - брокер событий

Так же класс предоставляет набор методов:

- `render(): HTMLElement` - отрисовывает форму

#### Класс OrderContactsView

Класс отвечает за отображение модального окна формы с контактами
- `constructor(container: HTMLElement, events: IEvents)` Конструктор принимает селектор, по которому будет идентифицированы разметка модального окна и также экземпляр класса `EventEmitter` для возможности инициации событий.

Поля класса:

- `_container: HTMLElement` - элемент контейнера модального окна
- `events: IEvents` - брокер событий

Так же класс предоставляет набор методов:

- `render(): HTMLElement` - отрисовывает форму


#### Класс OrderSuccessView

Класс отвечает за отображение финального модального окна заказа
- `constructor(container: HTMLElement, events: IEvents)` Конструктор принимает селектор, по которому будет идентифицированы разметка модального окна и также экземпляр класса `EventEmitter` для возможности инициации событий.

Поля класса:

- `_container: HTMLElement` - элемент контейнера модального окна
- `events: IEvents` - брокер событий

Так же класс предоставляет набор методов:

- `render(order: IOrderResponse): HTMLElement` - отображает финальное окно

### Слой коммуникации

#### Класс ShopApi

Принимает в конструктор экземпляр класса Api и предоставляет методы реализующие взаимодействие с бэкендом сервиса.

## Взаимодействие компонентов

Презентер отвечает за координацию работы между моделями ItemModel, CartModal и OrderModal, представлениями ModalView, CardView, CartView, OrderAddressView, OrderContactsView и OrderSuccessView, а также внешним слоем ModalApi 
Он подписывается на события от представления, обрабатывает бизнес-логику и вызывает соответствующие методы модели и обновления UI.\

#### класс Presenter

Класс отвечает за организацию бизнес-логики приложения и координацию работы между слоями.
- `constructor(items: ItemModel, cart: CartModel, order: OrderModel, cardView: CardView, cartView: CartView, orderAddressView: OrderAddressView, orderContactsView: OrderContactsView, orderSuccessView: OrderSuccessView, api: ShopApi, events: IEvents)` Конструктор принимает классы модели данных, классы представления, api и также экземпляр класса `EventEmitter` для возможности инициации событий. 

Поля класса:

- `_items: ItemModel` - класс отвечающий за хранение карточек
- `_cart: CartModel` - класс отвечающий за работу с корзиной
- `_order: OrderModal` - класс отвечающий за обработку заказа
- `_cardView: CardView` - класс отвечает за отображение карточек и модального окна товара
- `_cartView: CartView` - класс отвечает за отображение корзины и управление ее содержимым
- `_orderAddressView: OrderAddressView` - класс отвечает за отображение модального окна заказа
- `_orderContactsView: OrderContactsView` - класс отвечает за отображение модального окна заказа
- `_orderSuccessView: OrderSuccessView` - класс отвечает за отображение модального окна успешного заказа
- `_api: ShopApi` - класс отвечает за запросы к серверу
- `events: IEvents` - брокер событий
 
Методы класса: 

- `init(): void` - инициализация приложения, загрузка товаров из api, отображение списка
- `calculateTotal(): number` - считает общую сумму корзины
- `clickItem(id: ItemId): void` - открывает модальное окно с данными товара и вызывает событие для отображения нужного товара
- `clickAddToCart(id: ItemId): void` - добавляет товар в корзину
- `clickRemoveFromCart(id: ItemId): void` - удаляет товар из корзины
- `openCart(): void` - открывает корзину
- `openOrderAddress(): void` - открывает модальное окно с вводом адреса
- `submitAddress(address: string, payment: PaymentType): void` - сохраняет данные 
- `openOrderContacts(): void` - открывает модальное окно с вводом контактов
- `submitContacts(email: string, phone: string): void` - сохраняет данные
- `submitOrder(): Promise<void>` - отправляет данные, открывает окно с выполненным заказом
- `closeModal():void` - закрывает модальное окно

Код, описывающий взаимодействие представления и данных между собой находится в файле `index.ts`\
Взаимодействие осуществляется за счет событий генерируемых с помощью брокера событий и обработчиков этих событий, описанных в `index.ts`\
В `index.ts` сначала создаются экземпляры всех необходимых классов, а затем настраивается обработка событий.

*Список всех событий, которые могут генерироваться в системе:*\
*События изменения данных (генерируются классами моделями данных)*
- `items:changed` - изменение массива карточек товаров
- `item:preview` - выбор карточки для открытия в модальном окне
- `item:previewClear` - очистка данных выбранной для показа карточки 
- `cart:changed` - изменения содержимого корзины
- `order:changet` - при изменении данных формы
- `order:validation` - при валидации формы(boolean)

*События, возникающие при взаимодействии пользователя с интерфейсом (генерируются классами, отвечающими за представление)*
- `item:click` - открытие модального окна с товаром
- `item:add` - добавление товара в корзину
- `item:delete` - удаление товара из корзины(в самой корзине и в модальном окне)
- `cart:submit` - переход к оформлению заказа
- `order:addressInput` - ввод адреса
- `order:paymentInput` - выбор оплаты
- `order:addressSubmit` - подтверждение формы с адресом и типом оплаты
- `order:contactsInput` - изменение данных
- `order:contactsSubmit` - подтверждение формы с контактами
- `order:successClose` - кнопка в финальном окне для закрытия
- `modal:close` - закрытие любого модального окна




